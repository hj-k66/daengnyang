<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>DAENG NYANG</title>
  <!-- Bootstrap 5.2.3 Version -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script th:src="@{/fullcalendar-6.0.3/dist/index.global.js}"></script>

  <script>
    make_calendar();
    var rct_date;

    function make_calendar() {
      document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          contentHeight: 450,
          events: function (fetchInfo, successCallback, failureCallback) {
            var start = fetchInfo.start;
            var end = fetchInfo.end;

            var fromDate = date_to_yyyymmdd(start);
            var toDate = date_to_yyyymmdd(end);

            const param = "?fromDate=" + fromDate + "&toDate=" + toDate;
            axios.get("/api/v1/pets/" + petId + "/monitorings" + param, {}, {
              headers: {},
            }).then(res => {
              if (res.data.resultCode == 'SUCCESS') {
                monitorings = res.data.result.monthlyMonitorings;
                const dates = monitorings.map(mnt => mnt['date']);
                var events = dates.map(date => to_map(date));

                successCallback(events);
                make_table();
              } else {
                console.log("ì‹¤íŒ¨ì„" + res.resultCode)
              }
            });
          },
          eventClick: function (event, jsEvent, view) {
            console.log(event.event.start);
            rct_date = event;
          },
          dateClick: function (info) {
            rct_date = info.dateStr;
            $("#createModal").modal("show");
          }
        });
        calendar.render();
      });
    }
  </script>
  <style>
    a {
      text-decoration: none;
      color: inherit;
    }

    #createModal label {
      font-weight: bolder;
    }

    #mnt-table {
      background-color: white;
    }

    #mnt-table th, #mnt-table td {
      text-align: center;
      width: 100px;
    }

    #mnt-table .date-col {
      background-color: white;
      width: 160px;
    }

    #mnt-table .notes-col,
    #mnt-table .ci-name-col {
      width: 200px;
    }

    table .hidden {
      display: none;
    }
  </style>

</head>

<body>
<div th:replace="~{fragments/header :: header}"/>

<!--header----------------------------->


<!--calendar-->

<div class="container-fluid mt-5">
  <div class="row">
    <div class="col-lg-4">
      <div id="calendar" style="width: 400px; margin: auto;"></div>
      <div class="mt-3" style="width: 400px; margin: auto;">
        <form id="mnt-checking" style="width: 400px; margin: auto;">
          <legend>í•­ëª© ì„¤ì •</legend>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="weight-check" checked
                   value="weight-col">
            <label class="form-check-label ms-1" for="weight-check">ëª¸ë¬´ê²Œ</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="vomit-check" checked
                   value="vomit-col">
            <label class="form-check-label ms-1" for="vomit-check">êµ¬í† </label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="amPill-check" checked
                   value="amPill-col">
            <label class="form-check-label ms-1" for="amPill-check">ì•„ì¹¨ì•½</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="pmPill-check" checked
                   value="pmPill-col">
            <label class="form-check-label ms-1" for="pmPill-check">ì €ë…ì•½</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="cs-check" checked
                   value="cs-col">
            <label class="form-check-label ms-1" for="cs-check"><span
                class="cs-name">ì‚¬ìš©ìì„¤ì • (ì²´í¬)</span></label>
          </div>

          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="cs-name-check" checked
                   value="cs-name-col">
            <label class="form-check-label ms-1" for="cs-name-check">í•­ëª© ì´ë¦„</label>
          </div>

          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="feed-check" checked
                   value="feed-col">
            <label class="form-check-label ms-1" for="feed-check">ì‹ì´ëŸ‰</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="walk-check" checked
                   value="walk-col">
            <label class="form-check-label ms-1" for="walk-check">ì‚°ì±…</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="play-check" checked
                   value="play-col">
            <label class="form-check-label ms-1" for="play-check">ë†€ì´</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="uri-check" checked
                   value="uri-col">
            <label class="form-check-label ms-1" for="uri-check">ë°°ë‡¨</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="def-check" checked
                   value="def-col">
            <label class="form-check-label ms-1" for="def-check">ë°°ë³€</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="rr-check" checked
                   value="rr-col">
            <label class="form-check-label ms-1" for="rr-check">í˜¸í¡ìˆ˜</label>
          </div>
          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="ci-check" checked
                   value="ci-col">
            <label class="form-check-label ms-1" for="ci-check">ì‚¬ìš©ì ì„¤ì • (ê°’)</label>
          </div>

          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="ci-name-check" checked
                   value="ci-name-col">
            <label class="form-check-label ms-1" for="ci-name-check">í•­ëª© ì´ë¦„</label>
          </div>

          <div class="mb-3 form-check form-check-inline">
            <input type="checkbox" class="form-check-input con-check" id="notes-check" checked
                   value="notes-col">
            <label class="form-check-label ms-1" for="notes-check">íŠ¹ì´ ì‚¬í•­</label>
          </div>
          <button type="button" class="btn btn-primary btn-sm" onclick="select_contents()">í™•ì¸
          </button>
        </form>
      </div>
    </div>
    <div id="table-wrapper" class="col-lg-8"
         style="overflow-y: scroll; overflow-x: auto; height: 700px; width: 65%">


      <table id="mnt-table" class="table table-striped table-responsive" style="width: 1600px">
        <thead>
        <tr style="position: sticky; top: 0;">
          <th scope="col" class="date-col"></th>
          <th class="weight-col" scope="col">ëª¸ë¬´ê²Œ</th>
          <th class="vomit-col" scope="col">êµ¬í† </th>
          <th class="amPill-col" scope="col">ì•„ì¹¨ì•½</th>
          <th class="pmPill-col" scope="col">ì €ë…ì•½</th>
          <th class="cs-col" scope="col">ì‚¬ìš©ìì„¤ì •</th>
          <th class="cs-name-col" scope="col">í•­ëª© ì´ë¦„</th>
          <th class="feed-col" scope="col">ì‹ì´ëŸ‰</th>
          <th class="walk-col" scope="col">ì‚°ì±…</th>
          <th class="play-col" scope="col">ë†€ì´</th>
          <th class="uri-col" scope="col">ë°°ë‡¨</th>
          <th class="def-col" scope="col">ë°°ë³€</th>
          <th class="rr-col" scope="col">í˜¸í¡ìˆ˜</th>
          <th class="ci-col" scope="col">ì‚¬ìš©ìì„¤ì •</th>
          <th class="ci-name-col" scope="col">í•­ëª© ì´ë¦„</th>
          <th class="notes-col" scope="col">íŠ¹ì´ì‚¬í•­</th>
        </tr>
        </thead>

        <tbody id="mnt-table-body">
        <tr>
          <th scope="row" class="date-col" style="position: sticky; left: 0;">ë‚ ì§œ</th>
          <td class="weight-col">0</td>
          <td class="vomit-col">âœ˜</td>
          <td class="amPill-col">âœ”</td>
          <td class="pmPill-col">âœ”ï¸</td>
          <td class="cs-col">âœ˜ <span class="cs-name">ì‚¬ìš©ìì„¤ì •</span></td>
          <td class="feed-col">0</td>
          <td class="walk-col">0</td>
          <td class="play-col">0</td>
          <td class="uri-col">0</td>
          <td class="def-col">0</td>
          <td class="rr-col">0</td>
          <td class="ci-col">0</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<!--create modal-->

<div class="modal fade" id="createModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">ëª¨ë‹ˆí„°ë§ ë“±ë¡</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">

          <input type="checkbox" class="form-check-input" id="vomit" value="vomit">
          <label class="form-check-label" for="vomit">êµ¬í† </label>
          <input type="checkbox" class="form-check-input" id="amPill" value="amPill"
                 style="margin-left: 10px">
          <label class="form-check-label" for="amPill">ì•„ì¹¨ì•½</label>
          <input type="checkbox" class="form-check-input" id="pmPill" value="pmPill"
                 style="margin-left: 10px">
          <label class="form-check-label" for="pmPill">ì €ë…ì•½</label>
          <!--          custom-check-->
          <div class="input-group mb-3 mt-3">
            <div class="input-group-text">
              <input class="form-check-input mt-0" type="checkbox" id="customSymptom"
                     value="customSymptom" aria-label="Checkbox for following text input">
            </div>
            <input type="text" id="customSymptomName" class="form-control"
                   aria-label="Text input with checkbox" placeholder="ì‚¬ìš©ì ì§€ì • í•­ëª©">
          </div>

          <div class="row g-3 align-items-center mt-2">
            <div class="col-3">
              <label for="weight" class="col-form-label">ëª¸ë¬´ê²Œ</label>
            </div>
            <div class="col-auto">
              <input type="number" id="weight" class="form-control" min="0" step="0.1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="feedToGram" class="col-form-label">ì‹ì´ëŸ‰ (g)</label>
            </div>
            <div class="col-auto">
              <input type="number" id="feedToGram" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="walkCnt" class="col-form-label">ì‚°ì±… íšŸìˆ˜</label>
            </div>
            <div class="col-auto">
              <input type="number" id="walkCnt" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="playCnt" class="col-form-label">ë†€ì´ íšŸìˆ˜</label>
            </div>
            <div class="col-auto">
              <input type="number" id="playCnt" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="urination" class="col-form-label">ë°°ë‡¨</label>
            </div>
            <div class="col-auto">
              <input type="number" id="urination" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="defecation" class="col-form-label">ë°°ë³€</label>
            </div>
            <div class="col-auto">
              <input type="number" id="defecation" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="respiratoryRate" class="col-form-label">í˜¸í¡ìˆ˜</label>
            </div>
            <div class="col-auto">
              <input type="number" id="respiratoryRate" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <label class="col-form-label mt-2">ì‚¬ìš©ì ì§€ì • í•­ëª©</label>
          <div class="input-group mb-3 mt-1">
            <input type="text" id="customIntName" class="form-control" placeholder="í•­ëª© ì´ë¦„">
            <input type="number" id="customInt" min="0" step="1" class="form-control"
                   style="width: 40%;"
                   placeholder="íšŸìˆ˜">
          </div>

          <div class="mb-3">
            <label for="notes" class="form-label">íŠ¹ì´ ì‚¬í•­</label>
            <textarea class="form-control" id="notes" rows="3"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="addMonitoring"
                onclick="save_monitoring()">
          ì¶”ê°€
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!--show modal-->

<div class="modal fade" id="showModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="show-title">2023-01-01</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="modifyMonitoring">
          ìˆ˜ì •
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>


<!--footer---------------------------->

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
  const petId = [[${petId}]];
  let monitorings;

  // $(document).ready(function () {
  //   make_table();
  // });

  axios.defaults.withCredentials = true;

  function date_to_yyyymmdd(date) {
    const year = String(date.getFullYear());
    const month = String(date.getMonth() + 1);
    const day = String(date.getDate());
    return year + month.padStart(2, '0') + day.padStart(2, '0');
  }

  function to_map(date) {
    var result =
        {
          title: 'ğŸ“Œ',
          start: date
        };
    return result;
  }

  // -----------------make table
  function make_table() {
    $('#mnt-table-body').empty();
    for (let i = 0; i < monitorings.length; i++) {
      let vomit = (monitorings[i]['vomit'] == null) ? "-" : monitorings[i]['vomit'] ? "âœ”" : "âœ˜";
      let amPill = (monitorings[i]['amPill'] == null) ? "-" : monitorings[i]['amPill'] ? "âœ”" : "âœ˜";
      let pmPill = (monitorings[i]['pmPill'] == null) ? "-" : monitorings[i]['pmPill'] ? "âœ”" : "âœ˜";
      let customSymptom = (monitorings[i]['customSymptom'] == null) ? "-"
          : monitorings[i]['customSymptom'] ? "âœ”" : "âœ˜";
      let customSymptomName = (monitorings[i]['customSymptomName'] == null) ? ""
          : monitorings[i]['customSymptomName'];
      let date = (monitorings[i]['date'] == null) ? "-" : monitorings[i]['date'];
      let weight = (monitorings[i]['weight'] == null) ? "-" : monitorings[i]['weight'];
      let feedToGram = (monitorings[i]['feedToGram'] == null) ? "-" : monitorings[i]['feedToGram'];
      let walkCnt = (monitorings[i]['walkCnt'] == null) ? "-" : monitorings[i]['walkCnt'];
      let playCnt = (monitorings[i]['playCnt'] == null) ? "-" : monitorings[i]['playCnt'];
      let urination = (monitorings[i]['urination'] == null) ? "-" : monitorings[i]['urination'];
      let defecation = (monitorings[i]['defecation'] == null) ? "-" : monitorings[i]['defecation'];
      let respiratoryRate = (monitorings[i]['respiratoryRate'] == null) ? "-"
          : monitorings[i]['respiratoryRate'];
      let customInt = (monitorings[i]['customInt'] == null) ? "-" : monitorings[i]['customInt'];
      let customIntName = (monitorings[i]['customIntName'] == null) ? "-"
          : monitorings[i]['customIntName'];
      let notes = (monitorings[i]['notes'] == null) ? "-" : monitorings[i]['notes'];

      let temp_html = `
              <tr>
          <th scope="row" class="date-col" style="position: sticky; left: 0;">${date}</th>
          <td class="weight-col">${weight}</td>
          <td class="vomit-col">${vomit}</td>
          <td class="amPill-col">${amPill}</td>
          <td class="pmPill-col">${pmPill}</td>
          <td class="cs-col">${customSymptom}</td>
          <td class="cs-name-col">${customSymptomName}</td>
          <td class="feed-col">${feedToGram}</td>
          <td class="walk-col">${walkCnt}</td>
          <td class="play-col">${playCnt}</td>
          <td class="uri-col">${urination}</td>
          <td class="def-col">${defecation}</td>
          <td class="rr-col">${respiratoryRate}</td>
          <td class="ci-col">${customInt}</td>
          <td class="ci-name-col">${customIntName}</td>
          <td class="notes-col">${notes}</td>
        </tr>

      `;
      $('#mnt-table-body').append(temp_html);
    }
  }

  function select_contents() {
    make_table();
    let objs = document.getElementsByClassName("con-check");
    let show_con = [];
    for (let i = 0; i < objs.length; i++) {
      if (objs[i].checked == false) {
        show_con.push(objs[i].value);
      }
    }
    for (let i = 0; i < show_con.length; i++) {
      let col_name = show_con[i];
      let tds = document.getElementsByClassName(col_name);
      for (let j = 0; j < tds.length; j++) {
        tds.item(j).classList.add('hidden');
      }
    }
  }

  // -----------------save monitoring
  async function save_monitoring() {
    let date = rct_date;
    let weight = $("#weight").val();

    let vomit = $("#vomit").is(':checked');
    let amPill = $("#amPill").is(':checked');
    let pmPill = $("#pmPill").is(':checked');
    let customSymptom = $("#customSymptom").is(':checked');
    let customSymptomName = $("#customSymptomName").val();

    let feedToGram = $("#feedToGram").val();
    let walkCnt = $("#walkCnt").val();
    let playCnt = $("#playCnt").val();
    let urination = $("#urination").val();
    let defecation = $("#defecation").val();
    let respiratoryRate = $("#respiratoryRate").val();
    let customInt = $("#customInt").val();
    let customIntName = $("#customIntName").val();

    let notes = $("#notes").val();

    let params = {
      "date": date,
      "weight": weight,

      "vomit": vomit,
      "amPill": amPill,
      "pmPill": pmPill,
      "customSymptom": customSymptom,
      "customSymptomName": customSymptomName,

      "feedToGram": feedToGram,
      "walkCnt": walkCnt,
      "playCnt": playCnt,
      "urination": urination,
      "defecation": defecation,
      "respiratoryRate": respiratoryRate,
      "customInt": customInt,
      "customIntName": customIntName,

      "notes": notes
    };
    console.log(params.toString());

    await axios.post("/api/v1/pets/" + petId + "/monitorings", params, {}
    ).then(res => {
      if (res.data.resultCode == 'SUCCESS') {
        console.log(res.data.result);
        document.location.href = "/view/pets/" + petId + "/monitorings";
      } else {
        console.log("ì‹¤íŒ¨ì„" + res.resultCode)
      }
    });
  }

  axios.interceptors.request.use(function (config) {
    console.log("ì¸í„°ì…‰í„° ì‹œì‘")
    const accessToken = localStorage.getItem('accessToken');
    if (accessToken) {
      config.headers.Authorization = 'Bearer' + ' ' + accessToken
    } else {
      console.log("headers" + config.headers);
    }
    return config;
  })

</script>
</body>
</html>